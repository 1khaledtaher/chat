<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جروب الأصدقاء</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        /* Base styles & Responsive adjustments */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e6e9ee; /* Light grey background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            direction: rtl;
            padding: 0; /* Remove body padding for full screen chat on mobile */
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 15px; /* More rounded corners */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* Softer, deeper shadow */
            width: 100%;
            max-width: 650px; /* Slightly wider */
            height: 100vh; /* Full height on mobile */
            max-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Hide overflow content */
        }
        @media (min-width: 768px) {
            .container {
                height: 95vh; /* Slightly less than full height on desktop */
                margin: 2.5vh auto; /* Center vertically on desktop */
            }
        }
        
        /* Header */
        .chat-header {
            background-color: #007bff; /* Primary blue */
            color: white;
            padding: 18px 20px;
            font-size: 1.5em;
            font-weight: 600;
            text-align: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        @media (max-width: 767px) {
             .chat-header {
                border-radius: 0; /* No rounded corners on mobile full screen */
             }
        }

        /* Messages Container */
        #messages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa; /* Lighter background for messages */
            display: flex;
            flex-direction: column-reverse; /* New messages at the bottom */
            gap: 8px; /* Space between messages */
        }
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }
        #messages-container::-webkit-scrollbar-track {
            background-color: #f1f1f1;
        }

        /* Message Styling */
        .message-wrapper {
            display: flex;
            align-items: flex-end; /* Align sender name and text to bottom */
            margin-bottom: 5px; /* Space between message bubbles */
        }
        .message {
            max-width: 75%; /* Max width for message bubble */
            padding: 12px 16px;
            border-radius: 20px; /* More rounded bubbles */
            word-wrap: break-word;
            line-height: 1.4;
            position: relative; /* For actions menu */
        }
        .message.sent {
            background-color: #dcf8c6; /* WhatsApp green */
            align-self: flex-end; /* Align to right */
            margin-left: auto; /* Push to right */
            border-bottom-right-radius: 5px; /* Tail effect */
        }
        .message.received {
            background-color: #ffffff; /* White background */
            border: 1px solid #e0e0e0;
            align-self: flex-start; /* Align to left */
            margin-right: auto; /* Push to left */
            border-bottom-left-radius: 5px; /* Tail effect */
        }
        .message-sender {
            font-weight: 600;
            color: #075e54; /* Dark green for sender */
            margin-bottom: 4px;
            display: block;
            font-size: 0.9em;
            direction: rtl; /* For RTL names */
            text-align: right;
        }
        .message.received .message-sender {
            color: #4CAF50; /* Different color for received sender */
            text-align: left;
        }
        .message-text {
            color: #333;
            font-size: 1em;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
        }
        .message-timestamp {
            font-size: 0.75em;
            color: #777;
            margin-top: 5px;
            display: block;
            text-align: left;
            direction: ltr; /* Always LTR for timestamp */
        }
        .message.sent .message-timestamp {
            text-align: right; /* Timestamp on right for sent messages */
        }
        .message-edited {
            font-size: 0.7em;
            color: #999;
            margin-right: 5px;
            display: inline-block;
        }

        /* Message Actions Menu */
        .message-actions {
            position: absolute;
            top: 5px; /* Adjust as needed */
            left: 5px; /* For sent messages on the right */
            right: unset;
            display: none; /* Hidden by default */
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            flex-direction: column;
            min-width: 100px;
        }
        .message.received .message-actions {
            right: 5px; /* For received messages on the left */
            left: unset;
        }
        .message:hover .message-actions {
            display: flex; /* Show on hover */
        }
        .message-actions button {
            background: none;
            border: none;
            padding: 8px 12px;
            text-align: right;
            cursor: pointer;
            font-size: 0.9em;
            color: #333;
            white-space: nowrap;
        }
        .message-actions button:hover {
            background-color: #f0f0f0;
        }
        .message-actions button:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .message-actions button:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        /* Input Group */
        .input-group {
            display: flex;
            padding: 15px;
            background-color: #f0f2f5; /* Light grey background for input area */
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
            gap: 10px;
        }
        #message-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease;
            text-align: right;
        }
        #message-input:focus {
            border-color: #007bff;
        }
        #send-button, #cancel-edit-button {
            background-color: #007bff; /* Primary blue */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }
        #send-button:hover, #cancel-edit-button:hover {
            background-color: #0056b3;
        }
        #cancel-edit-button {
            background-color: #dc3545; /* Red for cancel */
            display: none; /* Hidden by default */
        }
        #cancel-edit-button:hover {
            background-color: #c82333;
        }

        /* Username Modal */
        .modal {
            display: flex;
            position: fixed;
            z-index: 1000; /* Higher z-index */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 12px; /* Slightly more rounded */
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
            text-align: center;
        }
        .modal-content h2 {
            margin-bottom: 25px;
            color: #333;
            font-size: 1.8em;
        }
        .modal-content input {
            width: calc(100% - 24px); /* Account for padding */
            padding: 12px;
            margin-bottom: 25px;
            border: 1px solid #bbb;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: right;
            outline: none;
        }
        .modal-content input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        .modal-content button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
        }
        .modal-content button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-header">جروب الأصدقاء</div>
        
        <div id="messages-container">
            <p style="text-align: center; color: #777;">جاري تحميل الرسائل...</p>
        </div>

        <div class="input-group">
            <input type="text" id="message-input" placeholder="اكتب رسالتك هنا..." autocomplete="off">
            <button id="send-button">إرسال</button>
            <button id="cancel-edit-button">إلغاء التعديل</button>
        </div>
    </div>

    <div id="usernameModal" class="modal">
        <div class="modal-content">
            <h2>أهلاً بك!</h2>
            <p>من فضلك أدخل اسمك للدخول إلى الجروب:</p>
            <input type="text" id="usernameModalInput" placeholder="اسمك هنا..." autocomplete="off">
            <button id="saveUsernameButton">دخول الجروب</button>
        </div>
    </div>

    <script>
        // Firebase configuration - YOUR KEYS ARE HERE
        const firebaseConfig = {
            apiKey: "AIzaSyDbWB2Ap3IY69pcSld0l3C9WzHgSKwJu3g",
            authDomain: "chat-54bb5.firebaseapp.com",
            projectId: "chat-54bb5",
            storageBucket: "chat-54bb5.appspot.com",
            messagingSenderId: "121445905738",
            appId: "1:121445905738:web:2f6a4490221d5cf039fdb3",
            measurementId: "G-6LENQFC67Z"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DOM Elements
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const usernameModal = document.getElementById('usernameModal');
        const usernameModalInput = document.getElementById('usernameModalInput');
        const saveUsernameButton = document.getElementById('saveUsernameButton');

        let currentUsername = '';
        let editingMessageId = null; // To store the ID of the message being edited

        // --- Username Modal Functions ---
        function showUsernameModal() {
            usernameModal.style.display = 'flex';
            usernameModalInput.focus();
        }

        function hideUsernameModal() {
            usernameModal.style.display = 'none';
        }

        function saveUsername() {
            const username = usernameModalInput.value.trim();
            if (username) {
                localStorage.setItem('chatUsername', username);
                currentUsername = username;
                hideUsernameModal();
                messageInput.focus();
            } else {
                alert("من فضلك أدخل اسمك!");
            }
        }

        // Check for username on load
        document.addEventListener('DOMContentLoaded', () => {
            const storedUsername = localStorage.getItem('chatUsername');
            if (storedUsername) {
                currentUsername = storedUsername;
                hideUsernameModal();
            } else {
                showUsernameModal();
            }
            // Ensure firestore is ready before listening
            listenForMessages();
        });

        saveUsernameButton.addEventListener('click', saveUsername);
        usernameModalInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveUsername();
            }
        });

        // --- Chat Functions ---
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate(); // Convert Firebase Timestamp to Date object
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.round(diffMs / (1000 * 60));
            const diffHours = Math.round(diffMs / (1000 * 60 * 60));

            if (diffMinutes < 1) return 'الآن';
            if (diffMinutes < 60) return `منذ ${diffMinutes} دقيقة`;
            if (diffHours < 24) return `منذ ${diffHours} ساعة`;
            
            const options = { hour: '2-digit', minute: '2-digit', hour12: true };
            return date.toLocaleTimeString('ar-EG', options) + ' - ' + date.toLocaleDateString('ar-EG');
        }

        function addMessageToUI(doc) {
            const messageData = doc.data();
            const messageId = doc.id;
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.dataset.id = messageId; // Store message ID for editing/deleting

            const isSentByUser = messageData.sender === currentUsername;

            if (isSentByUser) {
                messageDiv.classList.add('sent');
            } else {
                messageDiv.classList.add('received');
            }

            let messageContent = `
                <span class="message-sender">${messageData.sender}</span>
                <span class="message-text">${messageData.text}</span>
                <span class="message-timestamp">${formatTimestamp(messageData.timestamp)} ${messageData.edited ? '<span class="message-edited">(تم التعديل)</span>' : ''}</span>
            `;
            
            // Allow editing/deleting only for messages sent by the current user
            if (isSentByUser) {
                 messageContent += `
                    <div class="message-actions">
                        <button onclick="editMessage('${messageId}', '${encodeURIComponent(messageData.text)}')">تعديل</button>
                        <button onclick="deleteMessage('${messageId}')">حذف</button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = messageContent;
            messagesContainer.prepend(messageDiv);
        }

        // Firebase Listener for Messages
        function listenForMessages() {
            db.collection("messages").orderBy("timestamp", "desc").limit(50).onSnapshot((snapshot) => {
                messagesContainer.innerHTML = ''; // Clear existing messages
                snapshot.forEach((doc) => {
                    addMessageToUI(doc);
                });
            }, (error) => {
                console.error("Error getting messages: ", error);
                messagesContainer.innerHTML = '<p style="color: red; text-align: center;">حدث خطأ في تحميل الرسائل.</p>';
            });
        }


        // Send/Edit Message Function
        sendButton.addEventListener('click', async () => {
            const messageText = messageInput.value.trim();
            
            if (!currentUsername) {
                showUsernameModal();
                return;
            }

            if (messageText) {
                try {
                    if (editingMessageId) {
                        // Editing existing message
                        const messageRef = db.collection("messages").doc(editingMessageId);
                        await messageRef.update({
                            text: messageText,
                            edited: true
                        });
                        editingMessageId = null; // Clear editing state
                        sendButton.textContent = 'إرسال';
                        cancelEditButton.style.display = 'none';
                        messageInput.focus();
                    } else {
                        // Sending new message
                        await db.collection("messages").add({
                            sender: currentUsername,
                            text: messageText,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            edited: false
                        });
                    }
                    messageInput.value = ''; // Clear input
                } catch (e) {
                    console.error("Error sending/editing message: ", e);
                    alert("فشل إرسال/تعديل الرسالة. حاول مرة أخرى.");
                }
            } else {
                alert("الرجاء كتابة رسالتك.");
            }
        });

        // Cancel Edit Function
        cancelEditButton.addEventListener('click', () => {
            editingMessageId = null;
            messageInput.value = '';
            sendButton.textContent = 'إرسال';
            cancelEditButton.style.display = 'none';
            messageInput.focus();
        });

        // Keyboard Enter for sending
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        // --- Edit Message ---
        window.editMessage = (messageId, messageTextEncoded) => {
            const messageText = decodeURIComponent(messageTextEncoded);
            editingMessageId = messageId;
            messageInput.value = messageText;
            sendButton.textContent = 'تعديل'; // Change button text
            cancelEditButton.style.display = 'inline-block'; // Show cancel button
            messageInput.focus();
        };

        // --- Delete Message ---
        window.deleteMessage = async (messageId) => {
            if (confirm("هل أنت متأكد أنك تريد حذف هذه الرسالة؟")) {
                try {
                    await db.collection("messages").doc(messageId).delete();
                } catch (e) {
                    console.error("Error deleting message: ", e);
                    alert("فشل حذف الرسالة. حاول مرة أخرى.");
                }
            }
        };
    </script>
</body>
</html>
